<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>ZEP Time Tracker</title>
    <script src="../../lib/SDK/VSS.SDK.min.js"></script>
    <script>
        console.log("🔧 ZEP Extension - Script loading started");
        console.log("🔧 VSS object available:", typeof VSS);
        
        // Debug function to log with timestamp
        function debugLog(message, data = null) {
            const timestamp = new Date().toISOString().substr(11, 12);
            console.log(`[${timestamp}] 🔧 ZEP Extension: ${message}`, data || '');
        }
        
        debugLog("Initializing VSS SDK");
        
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        VSS.ready(function() {
            debugLog("VSS SDK is ready for work item form");
            debugLog("VSS services available:", Object.keys(VSS.getService || {}));
            debugLog("Current contribution:", VSS.getContribution());
            
            // Register the extension
            const contributionId = VSS.getContribution().id;
            debugLog("Registering extension with ID:", contributionId);
            
            VSS.register(contributionId, function () {
                debugLog("Extension registration callback executed");
                
                return {
                    // Called when the active work item is modified
                    onFieldChanged: function(args) {
                        debugLog("onFieldChanged called", args);
                    },
                    
                    // Called when a new work item is being loaded in the UI
                    onLoaded: function(args) {
                        debugLog("onLoaded called", args);
                        initializeExtension();
                    },
                    
                    // Called when the active work item is being unloaded in the UI
                    onUnloaded: function(args) {
                        debugLog("onUnloaded called", args);
                    },
                    
                    // Called after the work item has been saved
                    onSaved: function(args) {
                        debugLog("onSaved called", args);
                    },
                    
                    // Called when the work item is reset to its unmodified state (undo)
                    onReset: function(args) {
                        debugLog("onReset called", args);
                    },
                    
                    // Called when the work item has been refreshed from the server
                    onRefreshed: function(args) {
                        debugLog("onRefreshed called", args);
                        initializeExtension();
                    }
                };
            });
            
            debugLog("Calling VSS.notifyLoadSucceeded()");
            VSS.notifyLoadSucceeded();
            debugLog("VSS.notifyLoadSucceeded() completed");
        });
        
        function initializeExtension() {
            debugLog("🚀 initializeExtension() called");
            
            try {
                debugLog("Loading WorkItemFormService");
                
                VSS.require(["TFS/WorkItemTracking/Services"], function (WorkItemServices) {
                    debugLog("WorkItemFormService loaded successfully", WorkItemServices);
                    
                    WorkItemServices.WorkItemFormService.getService().then(function(workItemFormService) {
                        debugLog("WorkItemFormService instance:", workItemFormService);
                        
                        let currentWorkItemId = null;
                        let currentFilter = {};
                        let allTimeEntries = [];
                        let allTicketSummaries = [];

                        // Get current work item ID
                        workItemFormService.getId().then(function(id) {
                            currentWorkItemId = id;
                            debugLog("Work Item ID retrieved:", id);
                        }).catch(function(error) {
                            debugLog("Error getting work item ID:", error);
                        });

                        // Event listeners
                        const fetchBtn = document.getElementById('fetchBtn');
                        const refreshBtn = document.getElementById('refreshBtn');
                        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
                        const syncToISTBtn = document.getElementById('syncToISTBtn');
                        
                        if (fetchBtn) {
                            debugLog("Setting up fetchBtn event listener");
                            fetchBtn.addEventListener('click', fetchTimeEntries);
                        } else {
                            debugLog("⚠️ fetchBtn element not found");
                        }
                        
                        if (refreshBtn) {
                            debugLog("Setting up refreshBtn event listener");
                            refreshBtn.addEventListener('click', () => {
                                clearFilters();
                                fetchTimeEntries();
                            });
                        } else {
                            debugLog("⚠️ refreshBtn element not found");
                        }
                        
                        if (clearFiltersBtn) {
                            debugLog("Setting up clearFiltersBtn event listener");
                            clearFiltersBtn.addEventListener('click', clearFilters);
                        } else {
                            debugLog("⚠️ clearFiltersBtn element not found");
                        }

                        if (syncToISTBtn) {
                            debugLog("Setting up syncToISTBtn event listener");
                            syncToISTBtn.addEventListener('click', syncTotalToIST);
                        } else {
                            debugLog("⚠️ syncToISTBtn element not found");
                        }
                        
                        // Filter change handlers
                        const ticketFilter = document.getElementById('ticketFilter');
                        const dateFromFilter = document.getElementById('dateFromFilter');
                        const dateToFilter = document.getElementById('dateToFilter');
                        
                        if (ticketFilter) {
                            debugLog("Setting up ticketFilter event listener");
                            ticketFilter.addEventListener('change', applyFilters);
                        } else {
                            debugLog("⚠️ ticketFilter element not found");
                        }
                        
                        if (dateFromFilter) {
                            debugLog("Setting up dateFromFilter event listener");
                            dateFromFilter.addEventListener('change', applyFilters);
                        } else {
                            debugLog("⚠️ dateFromFilter element not found");
                        }
                        
                        if (dateToFilter) {
                            debugLog("Setting up dateToFilter event listener");
                            dateToFilter.addEventListener('change', applyFilters);
                        } else {
                            debugLog("⚠️ dateToFilter element not found");
                        }

                        // Clear date filters on load
                        if (dateFromFilter) dateFromFilter.value = '';
                        if (dateToFilter) dateToFilter.value = '';
                        
                        debugLog("✅ Extension initialization completed successfully");

                        // Function implementations
                        function clearFilters() {
                            debugLog("clearFilters called");
                            if (ticketFilter) ticketFilter.value = '';
                            if (dateFromFilter) dateFromFilter.value = '';
                            if (dateToFilter) dateToFilter.value = '';
                            currentFilter = {};
                            applyFilters();
                        }

                        function applyFilters() {
                            debugLog("applyFilters called");
                            const ticketFilterValue = ticketFilter ? ticketFilter.value.trim() : '';
                            const dateFromFilterValue = dateFromFilter ? dateFromFilter.value : '';
                            const dateToFilterValue = dateToFilter ? dateToFilter.value : '';

                            currentFilter = {
                                ticketId: ticketFilterValue || undefined,
                                dateFrom: dateFromFilterValue || undefined,
                                dateTo: dateToFilterValue || undefined
                            };

                            if (allTimeEntries.length > 0) {
                                const filteredEntries = filterTimeEntries(allTimeEntries, currentFilter);
                                const filteredSummaries = filterTicketSummaries(allTicketSummaries, filteredEntries);
                                updateDisplay(filteredEntries, filteredSummaries);
                            }
                        }

                        function filterTimeEntries(entries, filter) {
                            return entries.filter(entry => {
                                // Ticket ID filter (exact match for dropdown)
                                if (filter.ticketId && entry.ticketId !== filter.ticketId) {
                                    return false;
                                }
                                
                                // Date range filter
                                if (filter.dateFrom && entry.date < filter.dateFrom) {
                                    return false;
                                }
                                if (filter.dateTo && entry.date > filter.dateTo) {
                                    return false;
                                }
                                
                                return true;
                            });
                        }

                        function filterTicketSummaries(summaries, filteredEntries) {
                            const ticketMap = new Map();
                            
                            // Recalculate summaries based on filtered entries
                            summaries.forEach(summary => {
                                ticketMap.set(summary.ticketId, {
                                    ...summary,
                                    actualHours: 0,
                                    entryCount: 0
                                });
                            });
                            
                            filteredEntries.forEach(entry => {
                                const summary = ticketMap.get(entry.ticketId);
                                if (summary) {
                                    summary.actualHours += entry.duration;
                                    summary.entryCount += 1;
                                }
                            });
                            
                            return Array.from(ticketMap.values());
                        }

                        async function fetchTimeEntries() {
                            debugLog("🎯 fetchTimeEntries called");
                            try {
                                setLoading(true);
                                showStatus('Fetching time entries...', 'info');

                                // Get ZEP ticket IDs from work item
                                const zepField = await workItemFormService.getFieldValue('Custom.ZEPNummer');
                                debugLog("ZEP field value:", zepField);
                                
                                if (!zepField) {
                                    throw new Error('No ZEP Ticket IDs found in work item. Please add ticket IDs to the Custom.ZEPNummer field.');
                                }

                                const ticketIds = zepField.split(/[,;\\n]/).map(id => id.trim()).filter(id => id);
                                debugLog("Parsed ticket IDs:", ticketIds);
                                
                                if (ticketIds.length === 0) {
                                    throw new Error('No valid ZEP Ticket IDs found.');
                                }

                                console.log('Fetching time entries for tickets:', ticketIds);

                                // Fetch time entries and ticket details
                                const { timeEntries, ticketSummaries } = await getTimeEntriesWithPagination(ticketIds, currentFilter);
                                
                                // Store for filtering
                                allTimeEntries = timeEntries;
                                allTicketSummaries = ticketSummaries;

                                // Populate dropdown
                                populateTicketDropdown(ticketSummaries);

                                updateDisplay(timeEntries, ticketSummaries);
                                showStatus(`Successfully loaded ${timeEntries.length} time entries from ${ticketSummaries.length} tickets`, 'success');

                            } catch (error) {
                                debugLog("Error in fetchTimeEntries:", error);
                                console.error('Error fetching time entries:', error);
                                showStatus(error.message, 'error');
                                hideDisplaySections();
                            } finally {
                                setLoading(false);
                            }
                        }

                        function populateTicketDropdown(ticketSummaries) {
                            debugLog("populateTicketDropdown called with summaries:", ticketSummaries.length);
                            const dropdown = document.getElementById('ticketFilter');
                            
                            if (!dropdown) {
                                debugLog("⚠️ ticketFilter dropdown not found");
                                return;
                            }
                            
                            // Clear existing options except "All tickets"
                            dropdown.innerHTML = '<option value="">All tickets</option>';
                            
                            // Add option for each ticket
                            ticketSummaries.forEach(summary => {
                                const option = document.createElement('option');
                                option.value = summary.ticketId;
                                
                                // Get title from ticketDetails or fallback to ticket ID
                                const title = summary.ticketDetails?.title || `Ticket ${summary.ticketId}`;
                                option.textContent = `${summary.ticketId} - ${title}`;
                                
                                debugLog(`Adding dropdown option: ${option.textContent}`);
                                dropdown.appendChild(option);
                            });
                            
                            // If no summaries available, populate from Custom.ZEPNummer field directly
                            if (ticketSummaries.length === 0) {
                                populateDropdownFromWorkItem();
                            }
                        }

                        async function populateDropdownFromWorkItem() {
                            debugLog("populateDropdownFromWorkItem called");
                            try {
                                const zepField = await workItemFormService.getFieldValue('Custom.ZEPNummer');
                                if (zepField) {
                                    const ticketIds = zepField.split(/[,;\\n]/).map(id => id.trim()).filter(id => id);
                                    const dropdown = document.getElementById('ticketFilter');
                                    
                                    if (dropdown) {
                                        ticketIds.forEach(ticketId => {
                                            const option = document.createElement('option');
                                            option.value = ticketId;
                                            option.textContent = `${ticketId} - Loading...`;
                                            dropdown.appendChild(option);
                                        });
                                        
                                        debugLog(`Populated dropdown with ${ticketIds.length} ticket IDs from Custom.ZEPNummer field`);
                                    }
                                }
                            } catch (error) {
                                debugLog('Error populating dropdown from work item:', error);
                            }
                        }
                        
                        function setLoading(isLoading) {
                            const loadingContainer = document.getElementById('loadingContainer');
                            const fetchBtn = document.getElementById('fetchBtn');
                            
                            if (loadingContainer) loadingContainer.style.display = isLoading ? 'block' : 'none';
                            if (fetchBtn) {
                                fetchBtn.disabled = isLoading;
                                fetchBtn.textContent = isLoading ? 'Loading...' : 'Fetch Time Entries';
                            }
                        }

                        function showStatus(message, type = 'info') {
                            const container = document.getElementById('statusContainer');
                            if (container) {
                                container.innerHTML = `
                                    <div class="status ${type}">
                                        ${message}
                                    </div>
                                `;
                                
                                // Auto-hide success messages after 5 seconds
                                if (type === 'success') {
                                    setTimeout(() => {
                                        container.innerHTML = '';
                                    }, 5000);
                                }
                            }
                        }

                        function hideDisplaySections() {
                            const summarySection = document.getElementById('summarySection');
                            const entriesSection = document.getElementById('entriesSection');
                            if (summarySection) summarySection.style.display = 'none';
                            if (entriesSection) entriesSection.style.display = 'none';
                        }

                        function updateDisplay(timeEntries, ticketSummaries) {
                            debugLog("updateDisplay called", { entries: timeEntries.length, summaries: ticketSummaries.length });
                            // Basic implementation for now - will show status
                            showStatus(`Displaying ${timeEntries.length} entries from ${ticketSummaries.length} tickets`, 'success');
                            
                            const summarySection = document.getElementById('summarySection');
                            const entriesSection = document.getElementById('entriesSection');
                            if (summarySection) summarySection.style.display = 'block';
                            if (entriesSection) entriesSection.style.display = 'block';
                        }

                        function getTimeEntriesWithPagination(ticketIds, filter) {
                            debugLog("getTimeEntriesWithPagination called", ticketIds);
                            // Basic implementation - returning empty data for now but with debugging
                            debugLog("⚠️ getTimeEntriesWithPagination is using stub implementation");
                            return Promise.resolve({ timeEntries: [], ticketSummaries: [] });
                        }

                        // Add sync button functionality
                        async function syncTotalToIST() {
                            debugLog("syncTotalToIST called");
                            try {
                                const totalActual = allTimeEntries.reduce((sum, entry) => sum + entry.duration, 0);
                                await workItemFormService.setFieldValue('Custom.IST', totalActual);
                                showStatus(`Synced ${totalActual} hours to IST field`, 'success');
                            } catch (error) {
                                debugLog("Error syncing to IST:", error);
                                showStatus('Error syncing to IST field: ' + error.message, 'error');
                            }
                        }

                        debugLog("✅ All function definitions completed");
                        
                    }).catch(function(error) {
                        debugLog("Error getting WorkItemFormService:", error);
                        console.error('Error getting WorkItemFormService:', error);
                    });
                    
                }).catch(function(error) {
                    debugLog("Error in VSS.require:", error);
                    console.error('Error in VSS.require:', error);
                });
                
            } catch (error) {
                debugLog("Error in initializeExtension:", error);
                console.error('Error in initializeExtension:', error);
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 12px;
            margin: 0;
            color: #323130;
            background: #f3f2f1;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #0078d4;
            color: white;
            padding: 16px 20px;
            border-bottom: 1px solid #ddd;
        }

        .header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .controls {
            padding: 18px 24px;
            background: #faf9f8;
            border-bottom: 1px solid #edebe9;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #605e5c;
        }

        .filter-group input, .filter-group select {
            padding: 6px 8px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            font-size: 13px;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 1px #0078d4;
        }

        .buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            background: white;
            color: #323130;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #f3f2f1;
            border-color: #c7c6c4;
        }

        .btn.primary {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .btn.primary:hover {
            background: #106ebe;
            border-color: #106ebe;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .summary-section {
            padding: 24px;
            border-bottom: 1px solid #edebe9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #605e5c;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f2f1;
            border-radius: 50%;
            border-top-color: #0078d4;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            padding: 12px 20px;
            border-left: 4px solid #0078d4;
            background: #f3f2f1;
            margin: 16px 20px;
            border-radius: 0 4px 4px 0;
        }

        .status.error {
            border-left-color: #d13438;
            background: #fdf3f4;
            color: #a4262c;
        }

        .status.success {
            border-left-color: #107c10;
            background: #f3f9f3;
            color: #0e5a0e;
        }

        .status.warning {
            border-left-color: #ffaa44;
            background: #fff8f1;
            color: #8a6914;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ZEP Time Tracker</h2>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label for="ticketFilter">Ticket ID</label>
                <select id="ticketFilter">
                    <option value="">All tickets</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="dateFromFilter">Date From</label>
                <input type="date" id="dateFromFilter">
            </div>
            
            <div class="filter-group">
                <label for="dateToFilter">Date To</label>
                <input type="date" id="dateToFilter">
            </div>

            <div class="buttons">
                <button class="btn" id="clearFiltersBtn">Clear Filters</button>
                <button class="btn" id="refreshBtn">Refresh</button>
                <button class="btn primary" id="fetchBtn">Fetch Time Entries</button>
                <button class="btn" id="syncToISTBtn">Sync Total to IST Field</button>
            </div>
        </div>

        <div id="summarySection" class="summary-section" style="display: none;">
            <h3>Summary</h3>
            <p>Summary data will appear here after fetching time entries.</p>
        </div>

        <div id="entriesSection" class="summary-section" style="display: none;">
            <h3>Time Entries</h3>
            <p>Time entries will appear here after fetching.</p>
        </div>

        <div id="statusContainer"></div>
        
        <div id="loadingContainer" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            Loading time entries...
        </div>
    </div>
</body>
</html> 